## 09. 일관성과 합의

> 이번 장에서는 내결함성을 지닌 분산 시스템을 구축하는 데 쓰이는 알고리즘과 프로토콜의 몇 가지 예를 얘기한다.
내결함성을 지닌 시스템을 구축하는 가장 좋은 방법은 유용한 보장을 해주는 범용 추상화를 찾아 이를 구현하고 애플리케이션에서 이 보장에 의존하게 하는 것이다.
>
- 분산 시스템에서 가장 중요한 추상화 중 하나는 `합의`, 즉 **모든 노드가 어떤 것에 동의하게 만드는 것**이다.
- 어떤 상황에서는 시스템이 결함을 견뎌내고 계속 동작할 수 있지만 어떤 상황에서는 불가능하다. 먼저, 가능한 한계와 불가능한 한계들에 대한 개요를 살펴보자.

<br>

## 새롭게 알게 된 점(New)

### 일관성 보장

> 복제 데이터베이스가 제공하는 최종적 일관성은 약한 보장이다. 언제 복제본이 수렴될지는 아무도 모른다. 이때의 버그는 테스트로 발견하기 어려우며, 최종적 일관성의 에지 케이스는 시스템에 결함이 있거나 동시성이 높을 때만 분명히 드러난다.
>
- 강한 보장을 제공하는 시스템은 성능이 나쁘거나 약한 보장을 제공하는 시스템보다 내결함성이 약할지도 모른다.

<br>

### 선형성

(=원자적 일관성(atomic consistency), 강한 일관성(strong consistency), 즉각 일관성(immediate consistency), 외부 일관성(external consistency)

> 선형성의 기본 아이디어는 **시스템에 데이터 복사본이 하나만 있고 그 데이터를 대상으로 수행하는 모든 연산은 원자적인 것처럼 보이게 만드는 것**이다.
>
- `최신성 보장(recency guarantee)` : 읽힌 값이 최근에 갱신된 값이며, 뒤처지 캐시나 복제본에서 나온 값이 아니라고 보장해준다.

<br>

**[1] 요구사항**

- 클라이언트의 각 요청은 항상 **시간순**으로 진행돼야 하고 뒤로 갈 수 없다.
- 새로운 값이 쓰여지거나 읽히면 이후 실행되는 모든 읽기는 값이 다시 덮어쓰여질 때까지 쓰여진 값을 읽게 된다.

<br>

**[2] 선형성이 중요한 요구사항이 되는 영역**

1️⃣ 단일 리더 복제를 사용하는 시스템

모든 노드가 시작할 때 잠금 획득을 시도하고 성공한 노드가 리더가 된다. 모든 노드는 어느 노드가 잠금을 소유하는지에 동의해야 한다.

2️⃣ 데이터베이스의 유일성 제약 조건

관계형 데이터베이스에서 전형적으로 볼 수 있는 엄격한 유일성 제약 조건은 선형성이 필요하다.

3️⃣ 두 채널 사이의 타이밍

선형성의 최신성 보장이 없으면 파일 저장소와 메시지 큐 사이에 경쟁 조건이 발생할 수 있다.

<br>

**[3] 선형성 시스템 구현하기**

> 복제 방법 중에는 선형성을 제공하는 것도 있고 그렇지 않은 것도 있으므로 선형성의 장단점을 더 깊이 살펴보는 것은 흥미로운 일이다.
>

***참고. 5장 복제 방법***

| 방법 | 설명                                                                                                                                                                                            |
| --- |-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 단일 리더 복제(선형적이 될 가능성 있음) | - 리더가 아닌 노드가 자신이 리더라고 생각하고 계속 요청을 처리하면 선형성을 위반하기 쉽다.<br>- 비동기 복제를 사용하면 장애 복구를 할 때 커밋된 쓰기가 손실될 수 있으며 이는 지속성과 선형성을 모두 위반하는 것이다.                                                                 |
| 합의 알고리즘 | 스플릿 브레인과 복제본이 뒤처지는 문제를 막을 수단이 포함되어 선형성 저장소를 안전하게 구현할 수 있다.                                                                                                                                    |
| 다중 리더 복제(비선형적) | 여러 노드에서 동시에 쓰기를 처리하고 그렇게 쓰여진 내용을 비동기로 다른 노드에 복제하기 때문에 선형적이지 않다.                                                                                                                               |
| 리더 없는 복제(아마도 비선형적) | - 일 기준 시계를 기반으로 한 최종 쓰기 승리 충돌 해소 방법은 거의 확실히 비선형적이다.                                                                           <br>- 느슨한 정족수는 선형성의 가능성을 망친다. 엄격한 정족수를 사용해서 비선형적으로 동작할 가능성이 있다. |
- 다이나모 스타일 모델에서 엄격한 정족수를 사용한 읽기 쓰기는 네트워크 지연의 변동이 심하면 경쟁 조건이 생길 수 있다.

<br>

> 🤔 다이나모 스타일 정족수를 선형적으로 만들 방법은 없는 걸까?


**방법**

- 읽기를 실행하는 클라이언트는 결과를 애플리케이션에 반환하기 전에 읽기 복구를 동기식으로 수행한다.
- 쓰기를 실행하는 클라이언트는 쓰기 요청을 보내기 전에 노드들의 정족수로부터 최신 상태를 읽는다.

**한계**

- 선형성 읽기와 쓰기 연산만 구현할 수 있다. 선형성 compare-and-set 연산은 합의 알고리즘이 필요하므로 구현할 수 없다.

⇒ 다이나모 스타일 복제를 하는 리더 없는 시스템은 **선형성을 제공하지 않는다고 보는 게 가장 안전**하다.

<br>

**[4] 비용**

**1️⃣ CAP 정리**

> CAP(Consistency Availability Partition tolerance)는 네트워크 분단이 생겼을 때 일관성과 가용성 중 하나를 선택하라는 의미로 보는 게 좋다.
>

|  | 선형성을 요구하는 애플리케이션 | 선형성을 요구하지 않는 애플리케이션 |
| --- | --- | --- |
| 네트워크 문제로 복제 서버 간의 연결이 끊겼다면 | 네트워크 문제가 고쳐질 때까지 기다리거나 오류를 반환해야 한다. | 독립적으로 요청을 처리하는 방식으로 쓰기를 처리한다.  |
| 해결책의 가용성 여부 | NO | YES (비선형적) |

<br>

**2️⃣ 성능**

> 선형성은 느리다. 그리고 이것은 네트워크 결함이 있을 때만 그런 게 아니라 항상 참이다.
>
- 선형성을 제공하는 더욱 빠른 알고리즘은 존재하지 않지만 완화된 일관성 모델은 훨씬 더 빠를 수 있다.