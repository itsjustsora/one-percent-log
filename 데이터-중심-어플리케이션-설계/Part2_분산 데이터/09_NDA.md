## 09. 일관성과 합의

> 이번 장에서는 내결함성을 지닌 분산 시스템을 구축하는 데 쓰이는 알고리즘과 프로토콜의 몇 가지 예를 얘기한다.
내결함성을 지닌 시스템을 구축하는 가장 좋은 방법은 유용한 보장을 해주는 범용 추상화를 찾아 이를 구현하고 애플리케이션에서 이 보장에 의존하게 하는 것이다.
>
- 분산 시스템에서 가장 중요한 추상화 중 하나는 `합의`, 즉 **모든 노드가 어떤 것에 동의하게 만드는 것**이다.
- 어떤 상황에서는 시스템이 결함을 견뎌내고 계속 동작할 수 있지만 어떤 상황에서는 불가능하다. 먼저, 가능한 한계와 불가능한 한계들에 대한 개요를 살펴보자.

<br>

## 새롭게 알게 된 점(New)

### 일관성 보장

> 복제 데이터베이스가 제공하는 최종적 일관성은 약한 보장이다. 언제 복제본이 수렴될지는 아무도 모른다. 이때의 버그는 테스트로 발견하기 어려우며, 최종적 일관성의 에지 케이스는 시스템에 결함이 있거나 동시성이 높을 때만 분명히 드러난다.
>
- 강한 보장을 제공하는 시스템은 성능이 나쁘거나 약한 보장을 제공하는 시스템보다 내결함성이 약할지도 모른다.

<br>

### 선형성

(=원자적 일관성(atomic consistency), 강한 일관성(strong consistency), 즉각 일관성(immediate consistency), 외부 일관성(external consistency)

> 선형성의 기본 아이디어는 **시스템에 데이터 복사본이 하나만 있고 그 데이터를 대상으로 수행하는 모든 연산은 원자적인 것처럼 보이게 만드는 것**이다.
>
- `최신성 보장(recency guarantee)` : 읽힌 값이 최근에 갱신된 값이며, 뒤처지 캐시나 복제본에서 나온 값이 아니라고 보장해준다.

<br>

**[1] 요구사항**

- 클라이언트의 각 요청은 항상 **시간순**으로 진행돼야 하고 뒤로 갈 수 없다.
- 새로운 값이 쓰여지거나 읽히면 이후 실행되는 모든 읽기는 값이 다시 덮어쓰여질 때까지 쓰여진 값을 읽게 된다.

<br>

**[2] 선형성이 중요한 요구사항이 되는 영역**

1️⃣ 단일 리더 복제를 사용하는 시스템

모든 노드가 시작할 때 잠금 획득을 시도하고 성공한 노드가 리더가 된다. 모든 노드는 어느 노드가 잠금을 소유하는지에 동의해야 한다.

2️⃣ 데이터베이스의 유일성 제약 조건

관계형 데이터베이스에서 전형적으로 볼 수 있는 엄격한 유일성 제약 조건은 선형성이 필요하다.

3️⃣ 두 채널 사이의 타이밍

선형성의 최신성 보장이 없으면 파일 저장소와 메시지 큐 사이에 경쟁 조건이 발생할 수 있다.

<br>

**[3] 선형성 시스템 구현하기**

> 복제 방법 중에는 선형성을 제공하는 것도 있고 그렇지 않은 것도 있으므로 선형성의 장단점을 더 깊이 살펴보는 것은 흥미로운 일이다.
>

***참고. 5장 복제 방법***

| 방법 | 설명                                                                                                                                                                                            |
| --- |-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 단일 리더 복제(선형적이 될 가능성 있음) | - 리더가 아닌 노드가 자신이 리더라고 생각하고 계속 요청을 처리하면 선형성을 위반하기 쉽다.<br>- 비동기 복제를 사용하면 장애 복구를 할 때 커밋된 쓰기가 손실될 수 있으며 이는 지속성과 선형성을 모두 위반하는 것이다.                                                                 |
| 합의 알고리즘 | 스플릿 브레인과 복제본이 뒤처지는 문제를 막을 수단이 포함되어 선형성 저장소를 안전하게 구현할 수 있다.                                                                                                                                    |
| 다중 리더 복제(비선형적) | 여러 노드에서 동시에 쓰기를 처리하고 그렇게 쓰여진 내용을 비동기로 다른 노드에 복제하기 때문에 선형적이지 않다.                                                                                                                               |
| 리더 없는 복제(아마도 비선형적) | - 일 기준 시계를 기반으로 한 최종 쓰기 승리 충돌 해소 방법은 거의 확실히 비선형적이다.                                                                           <br>- 느슨한 정족수는 선형성의 가능성을 망친다. 엄격한 정족수를 사용해서 비선형적으로 동작할 가능성이 있다. |
- 다이나모 스타일 모델에서 엄격한 정족수를 사용한 읽기 쓰기는 네트워크 지연의 변동이 심하면 경쟁 조건이 생길 수 있다.

<br>

> 🤔 다이나모 스타일 정족수를 선형적으로 만들 방법은 없는 걸까?


**방법**

- 읽기를 실행하는 클라이언트는 결과를 애플리케이션에 반환하기 전에 읽기 복구를 동기식으로 수행한다.
- 쓰기를 실행하는 클라이언트는 쓰기 요청을 보내기 전에 노드들의 정족수로부터 최신 상태를 읽는다.

**한계**

- 선형성 읽기와 쓰기 연산만 구현할 수 있다. 선형성 compare-and-set 연산은 합의 알고리즘이 필요하므로 구현할 수 없다.

⇒ 다이나모 스타일 복제를 하는 리더 없는 시스템은 **선형성을 제공하지 않는다고 보는 게 가장 안전**하다.

<br>

**[4] 비용**

**1️⃣ CAP 정리**

> CAP(Consistency Availability Partition tolerance)는 네트워크 분단이 생겼을 때 일관성과 가용성 중 하나를 선택하라는 의미로 보는 게 좋다.
>

|  | 선형성을 요구하는 애플리케이션 | 선형성을 요구하지 않는 애플리케이션 |
| --- | --- | --- |
| 네트워크 문제로 복제 서버 간의 연결이 끊겼다면 | 네트워크 문제가 고쳐질 때까지 기다리거나 오류를 반환해야 한다. | 독립적으로 요청을 처리하는 방식으로 쓰기를 처리한다.  |
| 해결책의 가용성 여부 | NO | YES (비선형적) |

<br>

**2️⃣ 성능**

> 선형성은 느리다. 그리고 이것은 네트워크 결함이 있을 때만 그런 게 아니라 항상 참이다.
>
- 선형성을 제공하는 더욱 빠른 알고리즘은 존재하지 않지만 완화된 일관성 모델은 훨씬 더 빠를 수 있다.

<br>

### 순서화 보장

> 선형성의 정의는 연산들이 어떤 잘 정의된 순서대로 실행된다는 것을 암시한다.
>

**[1] 인과성**

- `인과성`은 이벤트에 **순서를 부과**한다.
- `인과적으로 일관적(casually consistent)` : 시스템이 인과성에 의해 부과된 순서를 지키는 것

<br>

**1️⃣ 인과적 순서가 전체 순서는 아니다**

**선형성은** 전체 순서화가 타임라인으로 설명될 수 있다. 반면, **인과성은** 전체 순서가 아닌 `부분 순서`를 정의한다는 뜻이다. 어떤 연산들은 서로에 대해 순서를 정할 수 있지만 어떤 연산들은 비교할 수 없다.

<br>

**2️⃣ 인과적 순서와 선형성 사이 관계**

> 선현성은 인과성을 내포한다. 어떤 시스템이든지 선형적이라면 인과성도 올바르게 유지한다.
>

어떤 분산 데이터 시스템들은 선형성을 포기해서 더 좋은 성능을 달성하지만 사용하기는 더 어렵다. 하지만, 성능 손해를 유발하지 않고도 인과적 일관성을 만족시키는 다른 방법을 선택할 수 있다. 즉, **선형성이 인과성을 보존하는 유일한 방법은 아니다.**

<br>

**3️⃣ 인과적 일관성의 핵심 아이디어**

> 🤔 비선형성 시스템이 어떻게 인과적 일관성을 유지할 수 있는가?
>

① 어떤 연산이 어떤 다른 연산보다 먼저 실행됐는지 알아야 한다.

전체 데이터베이스에 걸친 인과적 의존성을 추적하기 위해 버전 벡터(version vector)를 일반화할 수 있다.

② 시스템에 있는 노드에 관한 “지식”을 기술할 방법이 필요하다.

<br>

**[2] 일련번호 순서화**

- 일련번호나 타임스탬프로 전체 순서를 제공한다.
- 인과성에 일관적인 전체 순서대로 일련번호를 생성할 수 있다.

<br>

1️⃣ **램포트 타임스탬프**

> 각 노드는 고유 식별자를 갖고 각 노드는 처리한 연산 개수를 카운터로 유지한다. 램포트 타임스탬프는 (카운터, 노드ID)의 쌍이다. 두 노드는 때때로 카운터 값이 같을 수 있지만 타임스탬프에 노드 ID를 포함시켜서 각 타임스탬프는 유일하게 된다.
>
- 카운터가 큰 것이 타임스탬프가 크다.
- 카운터 값이 같으면 노드 ID가 큰 것이 타임스탬프가 크다.

<br>

2️⃣ **타임스탬프 순서화로 충분하지 않은 경우**

> 연산의 전체 순서는 모든 연산을 모은 후에야 드러난다. 다른 노드가 어떤 연산을 생성했지만 그것이 무엇인지 아직 알 수 없다면 연산의 최종 순서를 만들어낼 수 없다.
>
- 사용자명에 대한 유일성 제약 조건 같은 것을 구현하려면 연산의 전체 순서는 물론, 언제 그 순서가 확정되는지도 알아야 한다.

<br>

**[3] 전체 순서 브로드캐스트**

> 전체 순서 브로드캐스트를 구현하는 올바른 알고리즘은 노드나 네트워크에 결함이 있더라도 `신뢰성`과 `순서화` 속성이 항상 만족되도록 보장해야 한다.
>
- `상태 기계 복제(state machine replication)` : 모든 메시지가 데이터베이스에 쓰기를 나타내고 모든 복제 서버가 같은 쓰기 연산을 같은 순서로 처리하면 복제 서버들을 서로 일관성 있는 상태를 유지한다.
- 메시지는 고정된 순서로 **신뢰성** 있게 전달되도록 보장되지만, **비동기식**이기 때문에 언제 메시지가 전달될지는 보장되지 않는다.

<br>

> 💭 사용자명으로 사용자 계정을 유일하게 식별하도록 보장하려고 할 때
>

**1️⃣ 전체 순서 브로드캐스트로부터 선형성 `comapre-and-set` 연산 구현**

메시지를 로그에 추가해 점유하기 원하는 사용자명을 시험적으로 가리킨 후, 원하는 사용자명에 해당하는 첫 번째 메시지가 자신의 메시지일 때 연산을 수행한다.

**2️⃣ 선형성 저장소가 있을 때 전체 순서 브로드캐스트 구현**

모든 메시지에 대해 선형성 정수로 `increment-and-get` 연산을 수행하고 수신자들은 일련번호 순서대로 메시지를 전달한다.

<br>

> 🔉 **전체 순서 브로드캐스트와 타임스탬프 순서화의 핵심 차이**  
램포트 타임스탬프와는 달리 선형성 레지스터를 증가시켜서 얻은 숫자들은 틈이 없는 순열을 형성한다. 따라서 어떤 노드가 메시지 4를 전달하고, 일련번호가 6인 메시지를 받았다면 메시지 6을 전달하기 전에 5를 기다려야 한다는 것을 알 수 있다.


### 분산 트랜잭션과 합의

**[1] 원자적 커밋과 2단계 커밋(2PC)**

**1️⃣ 단일 노드에서 분산 원자적 커밋으로**

- `단일 노드`에서 트랜잭션 커밋은 데이터가 디스크에 지속성 있게 쓰여지는 순서에 결정적으로 의존한다. 데이터가 먼저고 커밋 레코드는 그 다음이다.
- `여러 노드`에서 한 노드가 커밋하기 위해서는 트랜잭션에 참여하는 다른 모든 노드도 커밋될 것이라고 확신할 수 있어야 한다.

<br>

**2️⃣ 2단계 커밋**

> 여러 노드에 걸친 원자적 트랜잭션 커밋을 달성하는, 즉 모든 노드가 커밋되거나 모든 노드가 어보트되도록 보장하는 알고리즘이다.


- `코디네이터(coordinator, 트랜잭션 관리자)` : 2PC가 사용하는 새로운 컴포넌트
- 애플리케이션이 커밋할 준비가 되면 코디네이터가 각 노드에 준비 요청을 보내 커밋할 수 있는지 질의한 후, 참여자들의 응답을 추적한다.

<br>

## 어려웠거나 이해하지 못한 부분(Difficulty)

## 추가 내용(Amendment)